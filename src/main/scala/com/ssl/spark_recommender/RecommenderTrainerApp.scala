package com.ssl.spark_recommender

import com.ssl.spark_recommender.trainer.ALSTrainer
import com.ssl.spark_recommender.utils.{Logging, MongoConfig}
import org.apache.spark.SparkConf
import scopt.OptionParser

/**
  * @author Brahma
  */
object RecommenderTrainerApp extends App with Logging {

  override def main(args: Array[String]) {
    val defaultParams = scala.collection.mutable.Map[String, Any]()
    defaultParams += "spark.cores" -> "local[*]"
    defaultParams += "spark.option" -> scala.collection.mutable.Map[String, String]()
    defaultParams += "mongo.uri" -> "mongodb://127.0.0.1:27017/spark_recommender"
    defaultParams += "mongo.db" -> "spark_recommender"
    defaultParams += "maxRecommendations" -> ALSTrainer.MAX_RECOMMENDATIONS.toString

    val parser = new OptionParser[scala.collection.mutable.Map[String, Any]]("RecommenderTrainerApp") {
      head("Recommendation System Trainer")
      opt[String]("spark.cores")
        .text("Number of cores in the Spark cluster")
        .action((x, c) => {
          c += "spark.cores" -> x
        })
      opt[Map[String,String]]("spark.option")
        .text("Spark Config Option")
        .valueName("spark.property1=value1,spark.property2=value2,...")
        .action { (x, c) => {
          c("spark.option").asInstanceOf[scala.collection.mutable.Map[String, Any]] ++= x.toSeq
          c
        }
        }
      opt[String]("mongo.uri")
        .text("Mongo Hosts")
        .action((x, c) => {
          c += "mongo.uri" -> x
        })
      opt[String]("mongo.db")
        .text("Mongo Database")
        .action((x, c) => {
          c += "mongo.db" -> x
        })
      opt[String]("maxRecommendations")
        .text("Maximum number of recommendations")
        .action((x, c) => {
          c += "maxRecommendations" -> x
        })
      help("help") text "prints this usage text"
    }
    parser.parse(args, defaultParams).map { params =>
      run(params.toMap)
    } getOrElse {
      System.exit(1)
    }
  }

  private def run(params: Map[String, Any]): Unit = {
    implicit val conf = new SparkConf().setAppName("RecommenderTrainerApp").setMaster(params("spark.cores").asInstanceOf[String])
    params("spark.option").asInstanceOf[scala.collection.mutable.Map[String, Any]].foreach { case (key: String, value: String) => conf.set(key, value) }

    implicit val mongoConf = new MongoConfig(params("mongo.uri").asInstanceOf[String], params("mongo.db").asInstanceOf[String])
    val maxRecommendations = params("maxRecommendations").asInstanceOf[String].toInt

    try {
      ALSTrainer.calculateRecs(maxRecommendations)
    }
    catch {
      case e: Exception =>
        logger.error("Error executing RecommenderTrainerApp", e)
        sys.exit(1)
    }

    sys.exit(0)
  }
}
